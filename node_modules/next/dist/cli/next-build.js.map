{"version":3,"sources":["../../src/cli/next-build.ts"],"sourcesContent":["#!/usr/bin/env node\n\nimport '../server/lib/cpu-profile'\nimport { existsSync } from 'fs'\nimport { italic } from '../lib/picocolors'\nimport build from '../build'\nimport { warn } from '../build/output/log'\nimport { printAndExit } from '../server/lib/utils'\nimport isError from '../lib/is-error'\nimport { getProjectDir } from '../lib/get-project-dir'\nimport { enableMemoryDebuggingMode } from '../lib/memory/startup'\nimport { disableMemoryDebuggingMode } from '../lib/memory/shutdown'\nimport { parseBundlerArgs } from '../lib/bundler'\n\nexport type NextBuildOptions = {\n  debug?: boolean\n  debugPrerender?: boolean\n  profile?: boolean\n  mangling: boolean\n  turbo?: boolean\n  turbopack?: boolean\n  webpack?: boolean\n  experimentalDebugMemoryUsage: boolean\n  experimentalAppOnly?: boolean\n  experimentalTurbo?: boolean\n  experimentalBuildMode: 'default' | 'compile' | 'generate' | 'generate-env'\n  experimentalUploadTrace?: string\n  experimentalNextConfigStripTypes?: boolean\n}\n\nconst nextBuild = (options: NextBuildOptions, directory?: string) => {\n  process.on('SIGTERM', () => process.exit(143))\n  process.on('SIGINT', () => process.exit(130))\n\n  const {\n    debug,\n    debugPrerender,\n    experimentalDebugMemoryUsage,\n    profile,\n    mangling,\n    experimentalAppOnly,\n    experimentalBuildMode,\n    experimentalUploadTrace,\n  } = options\n\n  let traceUploadUrl: string | undefined\n  if (experimentalUploadTrace && !process.env.NEXT_TRACE_UPLOAD_DISABLED) {\n    traceUploadUrl = experimentalUploadTrace\n  }\n\n  if (!mangling) {\n    warn(\n      `Mangling is disabled. ${italic('Note: This may affect performance and should only be used for debugging purposes.')}`\n    )\n  }\n\n  if (profile) {\n    warn(\n      `Profiling is enabled. ${italic('Note: This may affect performance.')}`\n    )\n  }\n\n  if (debugPrerender) {\n    warn(\n      `Prerendering is running in debug mode. ${italic(\n        'Note: This may affect performance and should not be used for production.'\n      )}`\n    )\n  }\n\n  if (experimentalDebugMemoryUsage) {\n    process.env.EXPERIMENTAL_DEBUG_MEMORY_USAGE = '1'\n    enableMemoryDebuggingMode()\n  }\n\n  const dir = getProjectDir(directory)\n\n  if (!existsSync(dir)) {\n    printAndExit(`> No such directory exists as the project root: ${dir}`)\n  }\n\n  const bundler = parseBundlerArgs(options)\n\n  return build(\n    dir,\n    profile,\n    debug || Boolean(process.env.NEXT_DEBUG_BUILD),\n    debugPrerender,\n    !mangling,\n    experimentalAppOnly,\n    bundler,\n    experimentalBuildMode,\n    traceUploadUrl\n  )\n    .catch((err) => {\n      if (experimentalDebugMemoryUsage) {\n        disableMemoryDebuggingMode()\n      }\n      console.error('')\n      if (\n        isError(err) &&\n        (err.code === 'INVALID_RESOLVE_ALIAS' ||\n          err.code === 'WEBPACK_ERRORS' ||\n          err.code === 'BUILD_OPTIMIZATION_FAILED' ||\n          err.code === 'NEXT_EXPORT_ERROR' ||\n          err.code === 'NEXT_STATIC_GEN_BAILOUT' ||\n          err.code === 'EDGE_RUNTIME_UNSUPPORTED_API')\n      ) {\n        printAndExit(`> ${err.message}`)\n      } else {\n        console.error('> Build error occurred')\n        printAndExit(err)\n      }\n    })\n    .finally(() => {\n      if (experimentalDebugMemoryUsage) {\n        disableMemoryDebuggingMode()\n      }\n    })\n}\n\nexport { nextBuild }\n"],"names":["nextBuild","options","directory","process","on","exit","debug","debugPrerender","experimentalDebugMemoryUsage","profile","mangling","experimentalAppOnly","experimentalBuildMode","experimentalUploadTrace","traceUploadUrl","env","NEXT_TRACE_UPLOAD_DISABLED","warn","italic","EXPERIMENTAL_DEBUG_MEMORY_USAGE","enableMemoryDebuggingMode","dir","getProjectDir","existsSync","printAndExit","bundler","parseBundlerArgs","build","Boolean","NEXT_DEBUG_BUILD","catch","err","disableMemoryDebuggingMode","console","error","isError","code","message","finally"],"mappings":";;;;;+BAyHSA;;;eAAAA;;;QAvHF;oBACoB;4BACJ;8DACL;qBACG;uBACQ;gEACT;+BACU;yBACY;0BACC;yBACV;;;;;;AAkBjC,MAAMA,YAAY,CAACC,SAA2BC;IAC5CC,QAAQC,EAAE,CAAC,WAAW,IAAMD,QAAQE,IAAI,CAAC;IACzCF,QAAQC,EAAE,CAAC,UAAU,IAAMD,QAAQE,IAAI,CAAC;IAExC,MAAM,EACJC,KAAK,EACLC,cAAc,EACdC,4BAA4B,EAC5BC,OAAO,EACPC,QAAQ,EACRC,mBAAmB,EACnBC,qBAAqB,EACrBC,uBAAuB,EACxB,GAAGZ;IAEJ,IAAIa;IACJ,IAAID,2BAA2B,CAACV,QAAQY,GAAG,CAACC,0BAA0B,EAAE;QACtEF,iBAAiBD;IACnB;IAEA,IAAI,CAACH,UAAU;QACbO,IAAAA,SAAI,EACF,CAAC,sBAAsB,EAAEC,IAAAA,kBAAM,EAAC,sFAAsF;IAE1H;IAEA,IAAIT,SAAS;QACXQ,IAAAA,SAAI,EACF,CAAC,sBAAsB,EAAEC,IAAAA,kBAAM,EAAC,uCAAuC;IAE3E;IAEA,IAAIX,gBAAgB;QAClBU,IAAAA,SAAI,EACF,CAAC,uCAAuC,EAAEC,IAAAA,kBAAM,EAC9C,6EACC;IAEP;IAEA,IAAIV,8BAA8B;QAChCL,QAAQY,GAAG,CAACI,+BAA+B,GAAG;QAC9CC,IAAAA,kCAAyB;IAC3B;IAEA,MAAMC,MAAMC,IAAAA,4BAAa,EAACpB;IAE1B,IAAI,CAACqB,IAAAA,cAAU,EAACF,MAAM;QACpBG,IAAAA,mBAAY,EAAC,CAAC,gDAAgD,EAAEH,KAAK;IACvE;IAEA,MAAMI,UAAUC,IAAAA,yBAAgB,EAACzB;IAEjC,OAAO0B,IAAAA,cAAK,EACVN,KACAZ,SACAH,SAASsB,QAAQzB,QAAQY,GAAG,CAACc,gBAAgB,GAC7CtB,gBACA,CAACG,UACDC,qBACAc,SACAb,uBACAE,gBAECgB,KAAK,CAAC,CAACC;QACN,IAAIvB,8BAA8B;YAChCwB,IAAAA,oCAA0B;QAC5B;QACAC,QAAQC,KAAK,CAAC;QACd,IACEC,IAAAA,gBAAO,EAACJ,QACPA,CAAAA,IAAIK,IAAI,KAAK,2BACZL,IAAIK,IAAI,KAAK,oBACbL,IAAIK,IAAI,KAAK,+BACbL,IAAIK,IAAI,KAAK,uBACbL,IAAIK,IAAI,KAAK,6BACbL,IAAIK,IAAI,KAAK,8BAA6B,GAC5C;YACAZ,IAAAA,mBAAY,EAAC,CAAC,EAAE,EAAEO,IAAIM,OAAO,EAAE;QACjC,OAAO;YACLJ,QAAQC,KAAK,CAAC;YACdV,IAAAA,mBAAY,EAACO;QACf;IACF,GACCO,OAAO,CAAC;QACP,IAAI9B,8BAA8B;YAChCwB,IAAAA,oCAA0B;QAC5B;IACF;AACJ","ignoreList":[0]}